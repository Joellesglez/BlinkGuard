# Documento de Arquitectura - Fatigue Detector

## 1. Organigrama del Proyecto

```
Detector de Fatiga Ocular
â”œâ”€â”€ AplicaciÃ³n Principal (main.py)
â”‚   â”œâ”€â”€ MÃ³dulos de VisiÃ³n
â”‚   â”‚   â”œâ”€â”€ MediaPipe Face Mesh
â”‚   â”‚   â”‚   â””â”€â”€ Landmarks oculares
â”‚   â”‚   â””â”€â”€ OpenCV (captura de video)
â”‚   â”œâ”€â”€ LÃ³gica de DetecciÃ³n
â”‚   â”‚   â”œâ”€â”€ CÃ¡lculo de EAR (Eye Aspect Ratio)
â”‚   â”‚   â”œâ”€â”€ DetecciÃ³n de ojos cerrados
â”‚   â”‚   â””â”€â”€ Temporizador de fatiga
â”‚   â””â”€â”€ Sistema de Alertas
â”‚       â”œâ”€â”€ ReproducciÃ³n de sonido (pygame)
â”‚       â””â”€â”€ VisualizaciÃ³n (OpenCVçª—å£)
â”‚
â””â”€â”€ Nodo n8n (src/)
    â”œâ”€â”€ FatigueDetector.node.ts
    â”‚   â”œâ”€â”€ ConfiguraciÃ³n de parÃ¡metros
    â”‚   â”œâ”€â”€ Modos de operaciÃ³n
    â”‚   â”‚   â”œâ”€â”€ Trigger
    â”‚   â”‚   â”œâ”€â”€ Data
    â”‚   â”‚   â””â”€â”€ Monitor
    â”‚   â””â”€â”€ DetecciÃ³n (real/simulada)
    â””â”€â”€ index.ts (punto de entrada)
```

## 2. Arquitectura del Sistema

```mermaid
flowchart TB
    subgraph "Componente Python Standalone"
        A[CÃ¡mara Web] --> B[OpenCV Capture]
        B --> C[MediaPipe Face Mesh]
        C --> D[CÃ¡lculo EAR]
        D --> E{Â¿Ojos cerrados?}
        E -->|SÃ­| F[Temporizador]
        E -->|No| G[Reiniciar temporizador]
        F --> H{Â¿Tiempo > umbral?}
        H -->|SÃ­| I[Reproducir Alerta]
        H -->|No| B
        Irar en --> J[Most ventana]
    end
    
    subgraph "Componente n8n"
        K[Webhook/Input] --> L[Fatigue Detector Node]
        L --> M[Modo Trigger]
        L --> N[Modo Data]
        L --> O[Modo Monitor]
        M --> P[Enviar Slack/Email]
        N --> Q[Devolver mÃ©tricas]
        O --> R[Loguear estado]
    end
```

## 3. Flujo de Funcionamiento

### 3.1 AplicaciÃ³n Python

```mermaid
sequenceDiagram
    participant User as Usuario
    participant Cam as CÃ¡mara
    participant MP as MediaPipe
    participant EAR as CÃ¡lculo EAR
    participant Timer as Temporizador
    participant Alert as Sistema Alerta
    
    User->>Cam: Iniciar captura de video
    Cam->>MP: Enviar frame RGB
    MP-->>EAR: Landmarks faciales
    EAR->>EAR: Calcular ratio ambos ojos
    EAR->>Timer: Comparar con umbral
    alt Ojos abiertos
        Timer->>Timer: Reiniciar conteo
    else Ojos cerrados
        Timer->>Timer: Incrementar tiempo
        Timer->>Alert: Â¿Tiempo > 3 seg?
        Alert->>User: Reproducir sonido alerta
    end
```

### 3.2 CÃ¡lculo de Eye Aspect Ratio (EAR)

```
Landmarks del ojo izquierdo: [33, 160, 158, 133, 153, 144]
Landmarks del ojo derecho: [362, 385, 387, 263, 373, 380]

EAR = (|yâ‚‚ - yâ‚†| + |yâ‚ƒ - yâ‚…|) / (2 Ã— |xâ‚ - xâ‚„|)

Donde:
- xâ‚, xâ‚„ = puntos horizontales del ojo
- yâ‚‚, yâ‚ƒ, yâ‚…, yâ‚† = puntos verticales del ojo

Umbral tÃ­pico: 0.18 (valor por defecto)
```

## 4. Mockups de la Interfaz

### 4.1 AplicaciÃ³n Python - Ventana de DetecciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Antigravity - DetecciÃ³n de ojos                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚    â”‚                                             â”‚          â”‚
â”‚    â”‚          [LIVE VIDEO FEED]                 â”‚          â”‚
â”‚    â”‚                                             â”‚          â”‚
â”‚    â”‚     â”Œâ”€â”€â”€â—â”€â”€â”€â”  â† Indicador de mirada        â”‚          â”‚
â”‚    â”‚     â”‚  (Â·)  â”‚                               â”‚          â”‚
â”‚    â”‚     â””â”€â”€â”€â”´â”€â”€â”€â”˜                               â”‚          â”‚
â”‚    â”‚                                             â”‚          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Estado: ðŸŸ¢ NORMAL  |  EAR: 0.25  |  Tiempo: 0.0s  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ [q] Salir  |  Umbral: 0.18  |  LÃ­mite: 3s         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Nodo n8n - Editor de Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fatigue Detector                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Propiedades:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Eye Closed Threshold    [0.18                      ] (0.05-0.5) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Closed Time Limit       [3                        ] (1-60) seg  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Alert Mode              [â–¼ Trigger Workflow       ]              â”‚   â”‚
â”‚  â”‚                         [  Return Data Only       ]              â”‚   â”‚
â”‚  â”‚                         [  Monitor Only           ]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Camera Index            [0                        ]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Monitor Duration        [30                       ] (0-300) seg â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Return All Metrics     [â˜‘]                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  Entradas: [main]                                     Salidas: [main]   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Ejemplo de Workflow en n8n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Webhook  â”‚ â”€â”€â–¶ â”‚ Fatigue Detectorâ”‚ â”€â”€â–¶ â”‚   IF    â”‚ â”€â”€â–¶ â”‚ Slack Alert â”‚
â”‚Trigger  â”‚     â”‚                 â”‚     â”‚ fatigue?â”‚     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  Continue  â”‚
                                     â”‚   Normal   â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5. ParÃ¡metros de ConfiguraciÃ³n

| ParÃ¡metro | Valor Defecto | Rango | DescripciÃ³n |
|-----------|---------------|-------|-------------|
| Eye Closed Threshold | 0.18 | 0.05 - 0.5 | Umbral EAR para considerar ojo cerrado |
| Closed Time Limit | 3 segundos | 1 - 60 | Tiempo con ojos cerrados para activar alerta |
| Camera Index | 0 | 0+ | Ãndice de la cÃ¡mara a usar |
| Monitor Duration | 30 segundos | 0 - 300 | DuraciÃ³n del monitoreo |

## 6. Salida de Datos

### Formato JSON (Modo Data)

```json
{
  "status": "alert",
  "fatigueDetected": true,
  "eyeAspectRatio": 0.15,
  "closedDuration": 3.5,
  "timestamp": "2024-01-15T10:30:00.000Z",
  "leftEyeRatio": 0.14,
  "rightEyeRatio": 0.16,
  "faceDetected": true
}
```

## 7. Dependencias del Proyecto

```
Python:
â”œâ”€â”€ opencv-python >= 4.8.0
â”œâ”€â”€ mediapipe >= 0.10.0
â””â”€â”€ pygame >= 2.5.0

TypeScript (n8n):
â”œâ”€â”€ n8n-workflow >= 1.0.0
â”œâ”€â”€ opencv4nodejs >= 6.2.0
â””â”€â”€ mediapipe >= 0.10.0
```
